rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // RoomTypes collection - room type definitions with inventory counts
    match /RoomTypes/{roomTypeId} {
      // Anyone can read room types to see availability
      allow read: if true;
      
      // Only authenticated admins can create, update, or delete room types
      allow write: if request.auth != null && 
                   request.auth.token.admin == true;
    }
    
    // Rooms collection (lowercase or capitalized - support both)
    match /rooms/{roomId} {
      // Anyone can read rooms to see availability
      allow read: if true;
      
      // Only authenticated admins can create, update, or delete rooms
      allow write: if request.auth != null && 
                   request.auth.token.admin == true;
    }
    match /Rooms/{roomId} {
      allow read: if true;
      allow write: if request.auth != null && 
                   request.auth.token.admin == true;
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      // Anyone can read bookings (needed for kiosk and ESP32/Raspberry Pi)
      allow read: if true;
      
      // Allow creating bookings with valid data (supports both roomId and roomTypeId)
      allow create: if request.resource.data.verificationCode is string && 
                    request.resource.data.verificationCode.size() == 6 &&
                    request.resource.data.guestName is string &&
                    request.resource.data.email is string &&
                    request.resource.data.checkIn is string &&
                    request.resource.data.checkOut is string &&
                    (request.resource.data.roomId is string || 
                     request.resource.data.roomTypeId is string);
      
      // Allow updating bookings to mark as verified
      // This is needed for self-check-in kiosk and IoT devices
      allow update: if (resource.data.verified == false && 
                       request.resource.data.verified == true) ||
                       request.auth != null;
      
      // Only authenticated users can delete
      allow delete: if request.auth != null;
    }
    match /Bookings/{bookingId} {
      allow read: if true;
      allow create: if request.resource.data.verificationCode is string && 
                    request.resource.data.verificationCode.size() == 6 &&
                    request.resource.data.guestName is string &&
                    request.resource.data.email is string &&
                    request.resource.data.checkIn is string &&
                    request.resource.data.checkOut is string &&
                    (request.resource.data.roomId is string || 
                     request.resource.data.roomTypeId is string);
      allow update: if (resource.data.verified == false && 
                       request.resource.data.verified == true) ||
                       request.auth != null;
      allow delete: if request.auth != null;
    }
  }
}
